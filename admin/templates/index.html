<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: #667eea;
            color: white;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 15px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 20px;
            margin-bottom: 20px;
        }

        .modal-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .sub-link {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            word-break: break-all;
            font-family: monospace;
            font-size: 12px;
        }

        .lang-switcher {
            display: flex;
            gap: 5px;
        }

        .lang-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }

        .lang-btn.active {
            background: rgba(255,255,255,0.4);
            border-color: rgba(255,255,255,0.6);
        }

        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }

        #qrcode canvas {
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1 data-i18n="title">Subscription Manager</h1>
            <div style="display: flex; gap: 15px; align-items: center;">
                <div class="lang-switcher">
                    <button class="lang-btn active" onclick="setLang('en')">EN</button>
                    <button class="lang-btn" onclick="setLang('ru')">RU</button>
                </div>
                <a href="/logout" class="logout-btn" data-i18n="logout">Logout</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="tabs">
            <button class="tab active" onclick="switchTab('nodes')" data-i18n="tab_nodes">Nodes</button>
            <button class="tab" onclick="switchTab('clients')" data-i18n="tab_clients">Clients</button>
            <button class="tab" onclick="switchTab('backups')" data-i18n="tab_backups">Backups</button>
        </div>

        <!-- Nodes Tab -->
        <div id="nodes-tab" class="tab-content active">
            <div class="card">
                <h2 data-i18n="add_node">Add New Node</h2>
                <form id="addNodeForm">
                    <div class="form-group">
                        <label data-i18n="node_name">Node Name</label>
                        <input type="text" name="name" required placeholder="node-vienna">
                    </div>
                    <div class="form-group">
                        <label data-i18n="panel_url">Panel URL</label>
                        <input type="url" name="url" required placeholder="https://100.64.1.5:2053">
                    </div>
                    <div class="form-group">
                        <label data-i18n="public_domain">Public Domain</label>
                        <input type="text" name="domain" required placeholder="vienna.example.com">
                    </div>
                    <div class="form-group">
                        <label data-i18n="username">Username</label>
                        <input type="text" name="username" required>
                    </div>
                    <div class="form-group">
                        <label data-i18n="password">Password</label>
                        <input type="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" data-i18n="btn_add_node">Add Node</button>
                </form>
            </div>

            <div class="card">
                <h2 data-i18n="nodes_list">Nodes</h2>
                <table id="nodesTable">
                    <thead>
                        <tr>
                            <th data-i18n="th_name">Name</th>
                            <th data-i18n="th_url">API URL</th>
                            <th data-i18n="th_domain">Domain</th>
                            <th data-i18n="th_clients">Clients</th>
                            <th data-i18n="th_traffic">Traffic</th>
                            <th data-i18n="th_status">Status</th>
                            <th data-i18n="th_actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Clients Tab -->
        <div id="clients-tab" class="tab-content">
            <div class="card">
                <h2 data-i18n="add_client">Add New Client</h2>
                <form id="addClientForm">
                    <div class="form-group">
                        <label data-i18n="email">Email</label>
                        <input type="text" name="email" required placeholder="user@example.com">
                    </div>
                    <div class="form-group">
                        <label data-i18n="manual_keys">Manual VLESS Keys (Optional)</label>
                        <textarea name="manual_keys" rows="4" placeholder="vless://uuid@domain:port?...&#10;vless://uuid@domain:port?...&#10;(One key per line)" style="font-family: monospace; font-size: 12px;"></textarea>
                        <small style="color: #7f8c8d; display: block; margin-top: 5px;" data-i18n="manual_keys_help">Optional: Add custom VLESS URLs (one per line). These won't be deleted when nodes are removed.</small>
                    </div>
                    <button type="submit" class="btn btn-primary" data-i18n="btn_add_client">Add Client</button>
                </form>
            </div>

            <div class="card">
                <h2 data-i18n="batch_create">Batch Create Clients</h2>
                <form id="batchClientForm">
                    <div class="form-group">
                        <label data-i18n="client_seed">Client Name Seed</label>
                        <input type="text" name="seed" required placeholder="Client" value="Client">
                    </div>
                    <div class="form-group">
                        <label data-i18n="client_count">Count</label>
                        <input type="number" name="count" required min="1" max="100" placeholder="20" value="20">
                    </div>
                    <p style="color: #7f8c8d; font-size: 13px;" data-i18n="batch_example">Example: "client" + 20 = client-a3f9b2e1, client-7d2c8f4a, ... (random)</p>
                    <button type="submit" class="btn btn-primary" data-i18n="btn_batch_create">Batch Create</button>
                </form>
            </div>

            <div class="card">
                <h2 data-i18n="clients_list">Clients</h2>
                <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                    <input type="text" id="clientSearch" data-i18n-placeholder="search_clients" placeholder="Search by email..." style="flex: 1; max-width: 400px;">
                    <button id="batchDeleteBtn" class="btn btn-danger" onclick="batchDeleteClients()" style="display: none;" data-i18n="btn_delete_selected">Delete Selected</button>
                </div>
                <table id="clientsTable">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllClients" onchange="toggleSelectAll()"></th>
                            <th data-i18n="th_email">Email</th>
                            <th data-i18n="th_status">Status</th>
                            <th data-i18n="th_ip_limit">IP Limit</th>
                            <th data-i18n="th_keys">Keys</th>
                            <th data-i18n="th_created">Created</th>
                            <th data-i18n="th_actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Backups Tab -->
        <div id="backups-tab" class="tab-content">
            <div class="card">
                <h2 data-i18n="backups_title">Node Backups</h2>
                <p style="color: #7f8c8d; margin-bottom: 20px;" data-i18n="backups_description">
                    Create and manage backups of all node databases
                </p>

                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="createBackup()" id="createBackupBtn" data-i18n="btn_create_backup">
                        Create New Backup
                    </button>
                    <div id="backupProgress" style="display: none; align-items: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border: 3px solid #f3f3f3; border-top: 3px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span data-i18n="creating_backup">Creating backup...</span>
                    </div>
                </div>

                <div style="margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong data-i18n="last_backup">Last backup:</strong>
                            <span id="lastBackupTime">-</span>
                        </div>
                        <div>
                            <strong data-i18n="total_backups">Total backups:</strong>
                            <span id="totalBackups">0</span>
                            <span style="margin-left: 20px;">
                                <strong data-i18n="total_size">Total size:</strong>
                                <span id="totalSize">0 MB</span>
                            </span>
                        </div>
                    </div>
                </div>

                <table id="backupsTable">
                    <thead>
                        <tr>
                            <th data-i18n="th_backup_date">Date/Time</th>
                            <th data-i18n="th_backup_size">Size</th>
                            <th data-i18n="th_backup_status">Status</th>
                            <th data-i18n="th_actions">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Node Modal -->
    <div id="editNodeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span data-i18n="edit_node">Edit Node</span>
                <span onclick="closeEditNodeModal()" style="float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: #999; line-height: 1;">&times;</span>
            </div>
            <form id="editNodeForm">
                <input type="hidden" id="editNodeId">
                <div class="form-group">
                    <label data-i18n="node_name">Node Name</label>
                    <input type="text" id="editNodeName" required>
                </div>
                <div class="form-group">
                    <label data-i18n="panel_url">API URL (Tailscale)</label>
                    <input type="url" id="editNodeUrl" required>
                </div>
                <div class="form-group">
                    <label data-i18n="public_domain">Public Domain</label>
                    <input type="text" id="editNodeDomain" required>
                </div>
                <div class="form-group">
                    <label data-i18n="username">Username</label>
                    <input type="text" id="editNodeUsername" required>
                </div>
                <div class="form-group">
                    <label data-i18n="password">Password</label>
                    <input type="password" id="editNodePassword" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" data-i18n="btn_save">Save</button>
                    <button type="button" class="btn" onclick="closeEditNodeModal()" data-i18n="btn_cancel">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subscription Modal -->
    <div id="subModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span data-i18n="modal_title">Subscription Link</span>
                <span onclick="closeSubModal()" style="float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: #999; line-height: 1;">&times;</span>
            </div>
            <div id="qrcode"></div>
            <p style="text-align: center; color: #7f8c8d; font-size: 13px; margin-bottom: 15px;" data-i18n="scan_instruction">Scan QR code with VPN app or copy link below</p>
            <div class="sub-link" id="subLink"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeSubModal()" data-i18n="btn_close">Close</button>
            </div>
        </div>
    </div>

    <!-- Batch Subscriptions Modal -->
    <div id="batchSubsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span data-i18n="batch_subs_title">Batch Subscription Links</span>
                <span onclick="closeBatchSubsModal()" style="float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: #999; line-height: 1;">&times;</span>
            </div>
            <p style="color: #7f8c8d; margin-bottom: 15px;" data-i18n="batch_subs_desc">Copy these subscription URLs and distribute to clients:</p>
            <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; word-break: break-all;">
                <pre id="batchSubsList" style="margin: 0;"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-success" onclick="copyBatchSubs()" data-i18n="btn_copy">Copy All</button>
                <button class="btn btn-primary" onclick="closeBatchSubsModal()" data-i18n="btn_close">Close</button>
            </div>
        </div>
    </div>

    <!-- View Keys Modal -->
    <div id="keysModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <span data-i18n="keys_modal_title">VLESS Keys</span>
                <span onclick="closeKeysModal()" style="float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: #999; line-height: 1;">&times;</span>
            </div>
            <p style="color: #7f8c8d; margin-bottom: 15px;"><strong data-i18n="client_label">Client:</strong> <span id="keysClientEmail"></span></p>
            <div id="keysList" style="background: #ecf0f1; padding: 15px; border-radius: 5px; max-height: 500px; overflow-y: auto;">
            </div>

            <!-- Add Manual Keys Section -->
            <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                <h3 style="margin-top: 0; font-size: 16px; color: #856404;" data-i18n="add_manual_keys_title">Add Manual Keys</h3>
                <form id="addManualKeysForm" onsubmit="addManualKeys(event)">
                    <input type="hidden" id="manualKeysClientId" name="client_id">
                    <div class="form-group" style="margin-bottom: 10px;">
                        <textarea name="manual_keys" rows="3" placeholder="vless://uuid@domain:port?...&#10;(One key per line)" style="font-family: monospace; font-size: 12px; width: 100%;"></textarea>
                        <small style="color: #856404; display: block; margin-top: 5px;" data-i18n="add_manual_keys_help">Paste VLESS URLs (one per line). These keys won't be deleted when nodes are removed.</small>
                    </div>
                    <button type="submit" class="btn" style="background: #ffc107; color: #000; font-size: 13px;" data-i18n="btn_add_keys">Add Keys</button>
                </form>
            </div>

            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeKeysModal()" data-i18n="btn_close">Close</button>
            </div>
        </div>
    </div>

    <!-- IP Limit Modal -->
    <div id="ipLimitModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; display: flex; flex-direction: column;">
            <div class="modal-header" style="flex-shrink: 0;">
                <span data-i18n="ip_limit_modal_title">IP Limit Settings</span>
                <span onclick="closeIpLimitModal()" style="float: right; cursor: pointer; font-size: 24px; font-weight: bold; color: #999; line-height: 1;">&times;</span>
            </div>

            <div style="flex: 1; overflow-y: auto; margin-bottom: 20px;">
                <p style="color: #7f8c8d; margin-bottom: 15px;"><strong data-i18n="client_label">Client:</strong> <span id="ipLimitClientEmail"></span></p>

                <div id="ipLimitLoading" style="text-align: center; padding: 20px;">
                    <div style="color: #667eea;" data-i18n="loading">Loading...</div>
                </div>

                <div id="ipLimitContent" style="display: none;">
                    <div style="background: #ecf0f1; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <p style="margin: 0 0 10px 0;"><strong data-i18n="current_limit_label">Current IP Limit:</strong> <span id="currentIpLimit" style="font-size: 18px; color: #667eea;">-</span></p>
                        <small style="color: #7f8c8d;" data-i18n="ip_limit_explanation">0 = unlimited, any number > 0 = max concurrent IPs allowed</small>
                    </div>

                    <form id="updateIpLimitForm" onsubmit="updateIpLimit(event)">
                        <input type="hidden" id="ipLimitClientId" name="client_id">
                        <div class="form-group">
                            <label data-i18n="new_limit_label">New IP Limit:</label>
                            <input type="number" name="limit_ip" min="0" required placeholder="0" style="width: 100%;">
                            <small style="color: #7f8c8d; display: block; margin-top: 5px;" data-i18n="ip_limit_help">Enter 0 for unlimited, or a number like 3, 6, etc.</small>
                        </div>
                        <button type="submit" class="btn btn-primary" data-i18n="btn_update_limit">Update Limit</button>
                    </form>
                </div>
            </div>

            <div class="modal-footer" style="flex-shrink: 0; border-top: 1px solid #ecf0f1; padding-top: 15px; margin-top: 0;">
                <button class="btn" onclick="closeIpLimitModal()" data-i18n="btn_close">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Translations
        const translations = {
            en: {
                title: 'Subscription Manager',
                logout: 'Logout',
                tab_nodes: 'Nodes',
                tab_clients: 'Clients',
                tab_backups: 'Backups',
                add_node: 'Add New Node',
                node_name: 'Node Name',
                panel_url: 'API URL (Tailscale)',
                public_domain: 'Public Domain',
                username: 'Username',
                password: 'Password',
                btn_add_node: 'Add Node',
                nodes_list: 'Nodes',
                th_name: 'Name',
                th_url: 'API URL',
                th_domain: 'Domain',
                th_clients: 'Clients',
                th_traffic: 'Traffic',
                th_status: 'Status',
                th_actions: 'Actions',
                add_client: 'Add New Client',
                email: 'Email',
                manual_keys: 'Manual VLESS Keys (Optional)',
                manual_keys_help: 'Optional: Add custom VLESS URLs (one per line). These won\'t be deleted when nodes are removed.',
                btn_add_client: 'Add Client',
                batch_create: 'Batch Create Clients',
                client_seed: 'Client Name Seed',
                client_count: 'Count',
                batch_example: 'Example: "client" + 20 = client-a3f9b2e1, client-7d2c8f4a, ... (random)',
                btn_batch_create: 'Batch Create',
                clients_list: 'Clients',
                search_clients: 'Search by email...',
                th_email: 'Email',
                th_keys: 'Keys',
                th_ip_limit: 'IP Limit',
                th_created: 'Created',
                modal_title: 'Subscription Link',
                scan_instruction: 'Scan QR code with VPN app or copy link below',
                btn_close: 'Close',
                btn_test: 'Test',
                btn_edit: 'Edit',
                btn_save: 'Save',
                btn_cancel: 'Cancel',
                btn_copy: 'Copy All',
                batch_subs_title: 'Batch Subscription Links',
                batch_subs_desc: 'Copy these subscription URLs and distribute to clients:',
                btn_delete: 'Delete',
                btn_delete_selected: 'Delete Selected',
                btn_enable: 'Enable',
                btn_disable: 'Disable',
                edit_node: 'Edit Node',
                btn_sub_link: 'Sub Link',
                btn_view_keys: 'View Keys',
                keys_modal_title: 'VLESS Keys',
                add_manual_keys_title: 'Add Manual Keys',
                add_manual_keys_help: 'Paste VLESS URLs (one per line). These keys won\'t be deleted when nodes are removed.',
                btn_add_keys: 'Add Keys',
                client_label: 'Client',
                status_enabled: 'Enabled',
                status_disabled: 'Disabled',
                confirm_delete_node: 'Delete this node?',
                confirm_delete_client: 'Delete this client from all nodes?',
                confirm_delete_key: 'Delete this manual key?',
                alert_created: 'Client created and synced to all nodes',
                alert_key_deleted: 'Manual key deleted',
                alert_keys_added: 'keys added',
                alert_error: 'Error',
                backups_title: 'Node Backups',
                backups_description: 'Create and manage backups of all node databases',
                btn_create_backup: 'Create New Backup',
                creating_backup: 'Creating backup...',
                last_backup: 'Last backup:',
                total_backups: 'Total backups:',
                total_size: 'Total size:',
                th_backup_date: 'Date/Time',
                th_backup_size: 'Size',
                th_backup_status: 'Status',
                btn_download: 'Download',
                btn_delete_backup: 'Delete',
                confirm_delete_backup: 'Delete this backup?',
                backup_status_ok: 'OK',
                backup_status_partial: 'Partial',
                backup_status_failed: 'Failed',
                alert_backup_created: 'Backup created successfully',
                alert_backup_deleted: 'Backup deleted',
                alert_backup_error: 'Backup failed',
                btn_edit_limit: 'Edit Limit',
                ip_limit_modal_title: 'IP Limit Settings',
                current_limit_label: 'Current IP Limit',
                ip_limit_explanation: '0 = unlimited, any number > 0 = max concurrent IPs allowed',
                new_limit_label: 'New IP Limit',
                ip_limit_help: 'Enter 0 for unlimited, or a number like 3, 6, etc.',
                btn_update_limit: 'Update Limit',
                loading: 'Loading...',
                ip_limit_unlimited: 'Unlimited',
                alert_limit_updated: 'IP limit updated successfully'
            },
            ru: {
                title: 'Менеджер подписок',
                logout: 'Выход',
                tab_nodes: 'Узлы',
                tab_clients: 'Клиенты',
                tab_backups: 'Резервные копии',
                add_node: 'Добавить новый узел',
                node_name: 'Имя узла',
                panel_url: 'API URL (Tailscale)',
                public_domain: 'Публичный домен',
                username: 'Имя пользователя',
                password: 'Пароль',
                btn_add_node: 'Добавить узел',
                nodes_list: 'Узлы',
                th_name: 'Имя',
                th_url: 'API URL',
                th_domain: 'Домен',
                th_clients: 'Клиенты',
                th_traffic: 'Трафик',
                th_status: 'Статус',
                th_actions: 'Действия',
                add_client: 'Добавить нового клиента',
                email: 'Email',
                manual_keys: 'Ручные VLESS ключи (необязательно)',
                manual_keys_help: 'Необязательно: Добавьте пользовательские VLESS URL (один на строку). Они не будут удалены при удалении узлов.',
                btn_add_client: 'Добавить клиента',
                batch_create: 'Массовое создание клиентов',
                client_seed: 'Базовое имя клиента',
                client_count: 'Количество',
                batch_example: 'Пример: "client" + 20 = client-a3f9b2e1, client-7d2c8f4a, ... (случайные)',
                btn_batch_create: 'Создать пакетом',
                clients_list: 'Клиенты',
                search_clients: 'Поиск по email...',
                th_email: 'Email',
                th_keys: 'Ключи',
                th_ip_limit: 'Лимит IP',
                th_created: 'Создан',
                modal_title: 'Ссылка на подписку',
                scan_instruction: 'Сканируйте QR код VPN приложением или скопируйте ссылку ниже',
                btn_close: 'Закрыть',
                btn_test: 'Тест',
                btn_edit: 'Изменить',
                btn_save: 'Сохранить',
                btn_cancel: 'Отмена',
                btn_copy: 'Копировать все',
                batch_subs_title: 'Список ссылок на подписки',
                batch_subs_desc: 'Скопируйте эти URL подписок и раздайте клиентам:',
                btn_delete: 'Удалить',
                btn_delete_selected: 'Удалить выбранное',
                btn_enable: 'Включить',
                btn_disable: 'Отключить',
                edit_node: 'Редактировать узел',
                btn_sub_link: 'Подписка',
                btn_view_keys: 'Просмотр ключей',
                keys_modal_title: 'VLESS ключи',
                add_manual_keys_title: 'Добавить ручные ключи',
                add_manual_keys_help: 'Вставьте VLESS URL (один на строку). Эти ключи не будут удалены при удалении узлов.',
                btn_add_keys: 'Добавить ключи',
                client_label: 'Клиент',
                status_enabled: 'Включен',
                status_disabled: 'Отключен',
                confirm_delete_node: 'Удалить этот узел?',
                confirm_delete_client: 'Удалить этого клиента со всех узлов?',
                confirm_delete_key: 'Удалить этот ручной ключ?',
                alert_created: 'Клиент создан и синхронизирован со всеми узлами',
                alert_key_deleted: 'Ручной ключ удален',
                alert_keys_added: 'ключей добавлено',
                alert_error: 'Ошибка',
                backups_title: 'Резервные копии узлов',
                backups_description: 'Создавайте и управляйте резервными копиями баз данных узлов',
                btn_create_backup: 'Создать новую копию',
                creating_backup: 'Создание копии...',
                last_backup: 'Последняя копия:',
                total_backups: 'Всего копий:',
                total_size: 'Общий размер:',
                th_backup_date: 'Дата/Время',
                th_backup_size: 'Размер',
                th_backup_status: 'Статус',
                btn_download: 'Скачать',
                btn_delete_backup: 'Удалить',
                confirm_delete_backup: 'Удалить эту копию?',
                backup_status_ok: 'ОК',
                backup_status_partial: 'Частичная',
                backup_status_failed: 'Ошибка',
                alert_backup_created: 'Резервная копия создана',
                alert_backup_deleted: 'Резервная копия удалена',
                alert_backup_error: 'Ошибка создания копии',
                btn_edit_limit: 'Изменить лимит',
                ip_limit_modal_title: 'Настройки лимита IP',
                current_limit_label: 'Текущий лимит IP',
                ip_limit_explanation: '0 = без ограничений, число > 0 = макс. количество одновременных IP',
                new_limit_label: 'Новый лимит IP',
                ip_limit_help: 'Введите 0 для безлимита, или число как 3, 6 и т.д.',
                btn_update_limit: 'Обновить лимит',
                loading: 'Загрузка...',
                ip_limit_unlimited: 'Без ограничений',
                alert_limit_updated: 'Лимит IP успешно обновлен'
            }
        };

        let currentLang = localStorage.getItem('lang') || 'en';

        function setLang(lang) {
            currentLang = lang;
            localStorage.setItem('lang', lang);

            // Update UI text
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                    el.textContent = translations[lang][key];
                }
            });

            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                if (translations[lang][key]) {
                    el.placeholder = translations[lang][key];
                }
            });

            // Update active button
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Reload current tab to update dynamic content
            const activeTab = document.querySelector('.tab.active');
            if (activeTab) {
                const tabName = activeTab.getAttribute('onclick').match(/'([^']+)'/)[1];
                if (tabName === 'nodes') loadNodes();
                if (tabName === 'clients') loadClients();
            }
        }

        // Apply language on load
        window.addEventListener('DOMContentLoaded', () => {
            const langBtn = document.querySelector(`.lang-btn[onclick="setLang('${currentLang}')"]`);
            if (langBtn) {
                langBtn.click();
            }
        });

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(tab + '-tab').classList.add('active');

            if (tab === 'nodes') loadNodes();
            if (tab === 'clients') loadClients();
            if (tab === 'backups') loadBackups();
        }

        // Load nodes
        async function loadNodes() {
            const response = await fetch('/api/nodes');
            const nodes = await response.json();

            const tbody = document.querySelector('#nodesTable tbody');
            tbody.innerHTML = '';

            // Load each node with stats
            for (const node of nodes) {
                const tr = document.createElement('tr');
                const statusText = node.enabled ? translations[currentLang].status_enabled : translations[currentLang].status_disabled;

                // Create row with loading state
                tr.innerHTML = `
                    <td>${node.name}</td>
                    <td>${node.url}</td>
                    <td>${node.domain}</td>
                    <td id="stats-${node.id}">...</td>
                    <td id="traffic-${node.id}">...</td>
                    <td><span class="badge badge-${node.enabled ? 'success' : 'danger'}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-success" onclick="testNode(${node.id})">${translations[currentLang].btn_test}</button>
                        <button class="btn btn-primary" onclick="editNode(${node.id})">${translations[currentLang].btn_edit}</button>
                        <button class="btn btn-danger" onclick="deleteNode(${node.id})">${translations[currentLang].btn_delete}</button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Fetch stats async
                fetchNodeStats(node.id);
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function fetchNodeStats(nodeId) {
            try {
                const response = await fetch(`/api/nodes/${nodeId}/stats`);
                const stats = await response.json();

                const statsCell = document.getElementById(`stats-${nodeId}`);
                const trafficCell = document.getElementById(`traffic-${nodeId}`);

                if (stats.online) {
                    // Show: online/total (enabled)
                    statsCell.innerHTML = `<span style="color: #27ae60;">${stats.online_clients}/${stats.total_clients}</span> <span style="color: #999; font-size: 11px;">(${stats.enabled_clients})</span>`;

                    // Show traffic: ↑up ↓down
                    trafficCell.innerHTML = `
                        <span style="color: #3498db; font-size: 12px;">
                            ↑${formatBytes(stats.traffic_up)}
                        </span><br>
                        <span style="color: #e67e22; font-size: 12px;">
                            ↓${formatBytes(stats.traffic_down)}
                        </span>
                    `;
                } else {
                    statsCell.innerHTML = `<span style="color: #e74c3c;">offline</span>`;
                    trafficCell.innerHTML = `<span style="color: #e74c3c;">-</span>`;
                }
            } catch (error) {
                const statsCell = document.getElementById(`stats-${nodeId}`);
                const trafficCell = document.getElementById(`traffic-${nodeId}`);
                statsCell.innerHTML = `<span style="color: #e74c3c;">error</span>`;
                trafficCell.innerHTML = `<span style="color: #e74c3c;">-</span>`;
            }
        }

        // Add node
        document.getElementById('addNodeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const response = await fetch('/api/nodes', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                if (data.synced_clients > 0 || data.failed_clients > 0) {
                    alert(`Node added!\nSynced ${data.synced_clients} clients\nFailed ${data.failed_clients} clients`);
                }
            }

            e.target.reset();
            loadNodes();
        });

        // Edit node
        async function editNode(id) {
            const response = await fetch(`/api/nodes/${id}`);
            const node = await response.json();

            document.getElementById('editNodeId').value = node.id;
            document.getElementById('editNodeName').value = node.name;
            document.getElementById('editNodeUrl').value = node.url;
            document.getElementById('editNodeDomain').value = node.domain;
            document.getElementById('editNodeUsername').value = node.username;
            document.getElementById('editNodePassword').value = node.password;

            document.getElementById('editNodeModal').classList.add('active');
        }

        function closeEditNodeModal() {
            document.getElementById('editNodeModal').classList.remove('active');
        }

        // Update node
        document.getElementById('editNodeForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editNodeId').value;
            const formData = new FormData();
            formData.append('name', document.getElementById('editNodeName').value);
            formData.append('url', document.getElementById('editNodeUrl').value);
            formData.append('domain', document.getElementById('editNodeDomain').value);
            formData.append('username', document.getElementById('editNodeUsername').value);
            formData.append('password', document.getElementById('editNodePassword').value);

            await fetch(`/api/nodes/${id}`, {
                method: 'PUT',
                body: formData
            });

            closeEditNodeModal();
            loadNodes();
        });

        // Test node
        async function testNode(id) {
            const response = await fetch(`/api/nodes/${id}/test`, {
                method: 'POST'
            });

            const result = await response.json();

            if (result.success) {
                alert('✓ ' + result.message);
            } else {
                alert('✗ ' + result.message);
            }
        }

        // Delete node
        async function deleteNode(id) {
            if (!confirm(translations[currentLang].confirm_delete_node)) return;

            const response = await fetch(`/api/nodes/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Node deleted!\n` +
                    `Deleted ${data.clients_deleted_on_node} clients from node\n` +
                    `Removed ${data.keys_removed} VLESS keys from subscriptions`);
            }

            loadNodes();
        }

        // Load clients
        async function loadClients() {
            const response = await fetch('/api/clients');
            const clients = await response.json();

            const tbody = document.querySelector('#clientsTable tbody');
            tbody.innerHTML = '';

            clients.forEach(client => {
                const tr = document.createElement('tr');
                const date = new Date(client.created_at).toLocaleDateString();
                const statusText = client.enabled ? translations[currentLang].status_enabled : translations[currentLang].status_disabled;

                // Add data attribute for searching
                tr.setAttribute('data-email', client.email.toLowerCase());
                tr.setAttribute('data-client-id', client.id);

                tr.innerHTML = `
                    <td><input type="checkbox" class="client-checkbox" value="${client.id}" onchange="updateBatchDeleteBtn()"></td>
                    <td>${client.email}</td>
                    <td><span class="badge badge-${client.enabled ? 'success' : 'danger'}">${statusText}</span></td>
                    <td id="ip-limit-${client.id}"><span style="color: #999;">-</span></td>
                    <td>${client.keys_count}</td>
                    <td>${date}</td>
                    <td>
                        ${client.enabled
                            ? `<button class="btn btn-warning" onclick="disableClient(${client.id})">${translations[currentLang].btn_disable}</button>`
                            : `<button class="btn btn-success" onclick="enableClient(${client.id})">${translations[currentLang].btn_enable}</button>`
                        }
                        <button class="btn btn-primary" onclick="showSubscription(${client.id})">${translations[currentLang].btn_sub_link}</button>
                        <button class="btn" style="background: #3498db; color: white;" onclick="showKeys(${client.id})">${translations[currentLang].btn_view_keys}</button>
                        <button class="btn" style="background: #f39c12; color: white;" onclick="showIpLimitModal(${client.id}, '${client.email}')">${translations[currentLang].btn_edit_limit}</button>
                        <button class="btn btn-danger" onclick="deleteClient(${client.id})">${translations[currentLang].btn_delete}</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Reset batch delete button
            updateBatchDeleteBtn();
        }

        // Client search filter
        document.getElementById('clientSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#clientsTable tbody tr');

            rows.forEach(row => {
                const email = row.getAttribute('data-email');
                if (email.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Add client
        document.getElementById('addClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const response = await fetch('/api/clients', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                e.target.reset();
                loadClients();
                alert(translations[currentLang].alert_created);
            } else {
                const error = await response.json();
                alert(translations[currentLang].alert_error + ': ' + error.detail);
            }
        });

        // Batch create clients
        document.getElementById('batchClientForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);

            const seed = formData.get('seed');
            const count = parseInt(formData.get('count'));

            if (!confirm(`Create ${count} clients with random suffixes?\nExample: ${seed}-a3f9b2e1, ${seed}-7d2c8f4a, ...`)) {
                return;
            }

            const response = await fetch('/api/clients/batch', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();

                // Build subscription list text
                let subsText = '';
                data.subscriptions.forEach(sub => {
                    subsText += `${sub.email}: ${sub.url}\n`;
                });

                // Show modal with subscription URLs
                document.getElementById('batchSubsList').textContent = subsText;
                document.getElementById('batchSubsModal').classList.add('active');

                loadClients();
            } else {
                const error = await response.json();
                alert('Error: ' + error.detail);
            }
        });

        function closeBatchSubsModal() {
            document.getElementById('batchSubsModal').classList.remove('active');
        }

        function copyBatchSubs() {
            const text = document.getElementById('batchSubsList').textContent;
            navigator.clipboard.writeText(text);
            alert('Copied to clipboard!');
        }

        // Batch delete functions
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllClients');
            const checkboxes = document.querySelectorAll('.client-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
            });
            updateBatchDeleteBtn();
        }

        function updateBatchDeleteBtn() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const btn = document.getElementById('batchDeleteBtn');

            if (checkboxes.length > 0) {
                btn.style.display = 'block';
                btn.textContent = `${translations[currentLang].btn_delete_selected} (${checkboxes.length})`;
            } else {
                btn.style.display = 'none';
            }
        }

        async function batchDeleteClients() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const clientIds = Array.from(checkboxes).map(cb => parseInt(cb.value));

            if (clientIds.length === 0) return;

            if (!confirm(`Delete ${clientIds.length} clients? This will remove them from all nodes.`)) {
                return;
            }

            const response = await fetch('/api/clients/batch-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({client_ids: clientIds})
            });

            if (response.ok) {
                const data = await response.json();
                alert(`Batch deletion complete!\n` +
                    `Deleted: ${data.deleted}\n` +
                    `Total keys removed: ${data.keys_removed}`);

                // Uncheck select all
                document.getElementById('selectAllClients').checked = false;

                loadClients();
            } else {
                alert('Error deleting clients');
            }
        }

        // Enable client
        async function enableClient(id) {
            await fetch(`/api/clients/${id}/enable`, {
                method: 'PUT'
            });
            loadClients();
        }

        // Disable client
        async function disableClient(id) {
            await fetch(`/api/clients/${id}/disable`, {
                method: 'PUT'
            });
            loadClients();
        }

        // Delete client
        async function deleteClient(id) {
            if (!confirm(translations[currentLang].confirm_delete_client)) return;

            await fetch(`/api/clients/${id}`, {
                method: 'DELETE'
            });

            loadClients();
        }

        // Show subscription
        async function showSubscription(id) {
            const response = await fetch(`/api/clients/${id}/subscription`);
            const data = await response.json();

            document.getElementById('subLink').textContent = data.subscription_url;

            // Clear previous QR code
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';

            // Generate new QR code
            new QRCode(qrcodeDiv, {
                text: data.subscription_url,
                width: 256,
                height: 256,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });

            document.getElementById('subModal').classList.add('active');
        }

        function closeSubModal() {
            document.getElementById('subModal').classList.remove('active');
            // Clear QR code when closing
            document.getElementById('qrcode').innerHTML = '';
        }

        // Show keys
        async function showKeys(id) {
            const response = await fetch(`/api/clients/${id}/keys`);
            const data = await response.json();

            document.getElementById('keysClientEmail').textContent = data.email;
            document.getElementById('manualKeysClientId').value = id;

            // Build keys list HTML
            const keysList = document.getElementById('keysList');
            keysList.innerHTML = '';

            data.keys.forEach((key, index) => {
                const keyDiv = document.createElement('div');
                keyDiv.style.marginBottom = '20px';
                keyDiv.style.padding = '15px';
                keyDiv.style.background = 'white';
                keyDiv.style.borderRadius = '5px';
                keyDiv.style.borderLeft = key.manual ? '4px solid #e74c3c' : '4px solid #667eea';

                const deleteButton = key.manual ? `
                    <button class="btn btn-danger" style="margin-top: 10px; margin-left: 10px; font-size: 12px;" onclick="deleteManualKey(${key.key_id}, ${id})">
                        ${translations[currentLang].btn_delete || 'Delete'}
                    </button>
                ` : '';

                keyDiv.innerHTML = `
                    <div style="font-weight: 600; color: ${key.manual ? '#e74c3c' : '#667eea'}; margin-bottom: 10px;">
                        ${key.node_name}${key.manual ? ' (Manual)' : ''}
                    </div>
                    <div style="font-family: monospace; font-size: 11px; word-break: break-all; color: #333; background: #f8f9fa; padding: 10px; border-radius: 3px;">
                        ${key.vless_url}
                    </div>
                    <button class="btn btn-primary" style="margin-top: 10px; font-size: 12px;" onclick="copyToClipboard('${key.vless_url.replace(/'/g, "\\'")}')">
                        ${translations[currentLang].btn_copy || 'Copy'}
                    </button>
                    ${deleteButton}
                `;

                keysList.appendChild(keyDiv);
            });

            document.getElementById('keysModal').classList.add('active');
        }

        function closeKeysModal() {
            document.getElementById('keysModal').classList.remove('active');
        }

        async function deleteManualKey(keyId, clientId) {
            if (!confirm(translations[currentLang].confirm_delete_key || 'Delete this manual key?')) {
                return;
            }

            try {
                const response = await fetch(`/api/keys/${keyId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // Reload the keys modal
                    showKeys(clientId);
                    alert(translations[currentLang].alert_key_deleted || 'Manual key deleted');
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        async function addManualKeys(event) {
            event.preventDefault();

            const form = event.target;
            const formData = new FormData(form);
            const clientId = document.getElementById('manualKeysClientId').value;

            try {
                const response = await fetch(`/api/clients/${clientId}/keys`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.added_count === 0) {
                        alert('No valid VLESS keys were added. Please check the format.');
                    } else {
                        alert(`${data.added_count} ${translations[currentLang].alert_keys_added || 'keys added'}`);
                    }

                    // Clear the textarea
                    form.querySelector('textarea[name="manual_keys"]').value = '';

                    // Reload the keys modal
                    showKeys(clientId);
                } else {
                    let errorMsg = 'Unknown error';
                    try {
                        const error = await response.json();
                        errorMsg = error.detail || JSON.stringify(error);
                    } catch {
                        errorMsg = await response.text();
                    }
                    alert(`Error: ${errorMsg}`);
                }
            } catch (error) {
                alert(`Error: ${error.message}`);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text);
            alert('Copied to clipboard!');
        }

        // IP Limit Management Functions
        async function showIpLimitModal(clientId, clientEmail) {
            document.getElementById('ipLimitClientId').value = clientId;
            document.getElementById('ipLimitClientEmail').textContent = clientEmail;

            // Show loading
            document.getElementById('ipLimitLoading').style.display = 'block';
            document.getElementById('ipLimitContent').style.display = 'none';

            // Show modal
            document.getElementById('ipLimitModal').classList.add('active');

            // Fetch current IP limit (with cache busting timestamp)
            try {
                const response = await fetch(`/api/clients/${clientId}/limit?t=${Date.now()}`);
                if (response.ok) {
                    const data = await response.json();
                    const limitText = data.limit_ip === 0 ? translations[currentLang].ip_limit_unlimited : data.limit_ip;

                    // Show node details if available
                    let nodeDetails = '';
                    if (data.nodes && Object.keys(data.nodes).length > 0) {
                        nodeDetails = '<div style="margin-top: 10px; font-size: 12px; color: #7f8c8d;">';
                        if (data.mismatch) {
                            nodeDetails += '<strong style="color: #e74c3c;">⚠️ Mismatch detected:</strong><br>';
                        }
                        for (const [nodeName, limit] of Object.entries(data.nodes)) {
                            const limitDisplay = limit === 0 ? '∞' : limit;
                            const color = data.mismatch && limit !== data.limit_ip ? '#e74c3c' : '#7f8c8d';
                            nodeDetails += `<span style="color: ${color};">${nodeName}: ${limitDisplay}</span><br>`;
                        }
                        nodeDetails += '</div>';
                    }
                    document.getElementById('currentIpLimit').innerHTML = limitText + nodeDetails;

                    // Hide loading, show content
                    document.getElementById('ipLimitLoading').style.display = 'none';
                    document.getElementById('ipLimitContent').style.display = 'block';

                    // Update table cell
                    const cell = document.getElementById(`ip-limit-${clientId}`);
                    if (cell) {
                        const displayHtml = data.limit_ip === 0
                            ? `<span style="color: #27ae60; font-weight: bold;">∞</span>`
                            : `<span style="color: #667eea; font-weight: bold;">${data.limit_ip}</span>`;
                        cell.innerHTML = data.mismatch ? displayHtml + ' ⚠️' : displayHtml;
                    }
                } else {
                    throw new Error('Failed to fetch IP limit');
                }
            } catch (error) {
                document.getElementById('ipLimitLoading').innerHTML = `<div style="color: #e74c3c;">${translations[currentLang].alert_error}: ${error.message}</div>`;
            }
        }

        function closeIpLimitModal() {
            document.getElementById('ipLimitModal').classList.remove('active');
            // Reset form
            document.getElementById('updateIpLimitForm').reset();
        }

        async function updateIpLimit(event) {
            event.preventDefault();

            const form = event.target;
            const clientId = document.getElementById('ipLimitClientId').value;
            const limitIp = parseInt(form.querySelector('input[name="limit_ip"]').value);

            try {
                const response = await fetch(`/api/clients/${clientId}/limit`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ limit_ip: limitIp })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(translations[currentLang].alert_limit_updated || 'IP limit updated successfully');

                    // Close modal first
                    closeIpLimitModal();

                    // Fetch fresh data from server (with cache busting)
                    try {
                        const freshResponse = await fetch(`/api/clients/${clientId}/limit?t=${Date.now()}`);
                        if (freshResponse.ok) {
                            const freshData = await freshResponse.json();

                            // Update table cell with fresh data
                            const cell = document.getElementById(`ip-limit-${clientId}`);
                            if (cell) {
                                const displayHtml = freshData.limit_ip === 0
                                    ? `<span style="color: #27ae60; font-weight: bold;">∞</span>`
                                    : `<span style="color: #667eea; font-weight: bold;">${freshData.limit_ip}</span>`;
                                cell.innerHTML = freshData.mismatch ? displayHtml + ' ⚠️' : displayHtml;
                            }
                        }
                    } catch (error) {
                        console.error('Failed to refresh IP limit:', error);
                    }
                } else {
                    const error = await response.json();
                    alert(`${translations[currentLang].alert_error}: ${error.detail}`);
                }
            } catch (error) {
                alert(`${translations[currentLang].alert_error}: ${error.message}`);
            }
        }

        // Backup Management Functions
        async function createBackup() {
            const btn = document.getElementById('createBackupBtn');
            const progress = document.getElementById('backupProgress');

            btn.disabled = true;
            progress.style.display = 'flex';

            try {
                const response = await fetch('/api/admin/backup', { method: 'POST' });
                const data = await response.json();
                console.log('Backup response:', data);

                if (data.success) {
                    alert(translations[currentLang].alert_backup_created);
                    loadBackups();
                } else {
                    console.error('Backup error:', data.error);
                    alert(`${translations[currentLang].alert_backup_error}: ${data.error}`);
                }
            } catch (error) {
                console.error('Request error:', error);
                alert(`${translations[currentLang].alert_error}: ${error.message}`);
            } finally {
                btn.disabled = false;
                progress.style.display = 'none';
            }
        }

        async function loadBackups() {
            try {
                const response = await fetch('/api/admin/backups');
                const data = await response.json();
                console.log('Backups list:', data);

                // Update statistics
                const backups = data.backups || [];
                const totalBackupsEl = document.getElementById('totalBackups');
                if (totalBackupsEl) {
                    totalBackupsEl.textContent = backups.length;
                }

                if (backups.length > 0) {
                    const totalSize = backups.reduce((sum, b) => sum + b.size, 0);
                    const totalSizeEl = document.getElementById('totalSize');
                    const lastBackupTimeEl = document.getElementById('lastBackupTime');

                    if (totalSizeEl) {
                        totalSizeEl.textContent = formatSize(totalSize);
                    }
                    if (lastBackupTimeEl) {
                        lastBackupTimeEl.textContent = formatDate(backups[0].created);
                    }
                }

                // Populate table
                const tbody = document.querySelector('#backupsTable tbody');
                if (!tbody) return;

                tbody.innerHTML = '';

                backups.forEach(backup => {
                    const row = document.createElement('tr');
                    const status = getBackupStatus(backup);
                    console.log('Backup status for', backup.backup_id, ':', status, 'metadata:', backup.metadata);

                    row.innerHTML = `
                        <td>${formatDate(backup.created)}</td>
                        <td>${formatSize(backup.size)}</td>
                        <td>${status}</td>
                        <td>
                            <button class="btn" onclick="downloadBackup('${backup.backup_id}')">${translations[currentLang].btn_download}</button>
                            <button class="btn btn-danger" onclick="deleteBackup('${backup.backup_id}')">${translations[currentLang].btn_delete_backup}</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Failed to load backups:', error);
            }
        }

        function downloadBackup(backupId) {
            window.location.href = `/api/admin/backups/${backupId}/download`;
        }

        async function deleteBackup(backupId) {
            if (!confirm(translations[currentLang].confirm_delete_backup)) return;

            try {
                const response = await fetch(`/api/admin/backups/${backupId}`, { method: 'DELETE' });
                if (response.ok) {
                    alert(translations[currentLang].alert_backup_deleted);
                    loadBackups();
                }
            } catch (error) {
                alert(`${translations[currentLang].alert_error}: ${error.message}`);
            }
        }

        function formatSize(bytes) {
            const mb = bytes / (1024 * 1024);
            return mb < 1 ? `${(bytes / 1024).toFixed(1)} KB` : `${mb.toFixed(1)} MB`;
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleString();
        }

        function getBackupStatus(backup) {
            if (!backup.metadata) return translations[currentLang].backup_status_ok;
            const meta = backup.metadata;
            if (meta.nodes_backed_up === meta.total_nodes) {
                return `✓ ${translations[currentLang].backup_status_ok}`;
            } else if (meta.nodes_backed_up > 0) {
                return `⚠ ${translations[currentLang].backup_status_partial}`;
            } else {
                return `✗ ${translations[currentLang].backup_status_failed}`;
            }
        }

        // Initial load
        loadNodes();

        // Global ESC key handler for closing modals
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' || event.keyCode === 27) {
                // Close IP Limit Modal
                const ipLimitModal = document.getElementById('ipLimitModal');
                if (ipLimitModal && ipLimitModal.classList.contains('active')) {
                    closeIpLimitModal();
                    return;
                }

                // Close Subscription Modal
                const subModal = document.getElementById('subModal');
                if (subModal && subModal.classList.contains('active')) {
                    closeSubModal();
                    return;
                }

                // Close Batch Subscriptions Modal
                const batchSubsModal = document.getElementById('batchSubsModal');
                if (batchSubsModal && batchSubsModal.classList.contains('active')) {
                    closeBatchSubsModal();
                    return;
                }

                // Close Keys Modal
                const keysModal = document.getElementById('keysModal');
                if (keysModal && keysModal.classList.contains('active')) {
                    closeKeysModal();
                    return;
                }

                // Close Edit Node Modal
                const editNodeModal = document.getElementById('editNodeModal');
                if (editNodeModal && editNodeModal.classList.contains('active')) {
                    closeEditNodeModal();
                    return;
                }
            }
        });
    </script>
</body>
</html>
